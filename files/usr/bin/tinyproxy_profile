#!/bin/bash -e

cmd=$1
arg2=$2

proxyconfprefix="/etc/tinyproxy/tinyproxy.conf"
currlink=$(readlink -f "$proxyconfprefix")
pl=$((${#proxyconfprefix} + 1))

function currentprofile() {
	echo "${currlink:$pl}"
}

function setprofile() {
	prof="$1"

	if [ "$(currentprofile)" = "$prof" ];
	then
		echo "Proxy already set to '$prof'"
		exit 0
	fi

	echo -n "Setting proxy to '$prof'... "
	pf="$proxyconfprefix.$prof"

	if [ -e "$pf" ];
	then
		ln -sf "$pf" "$proxyconfprefix"
		echo "Done."

		/etc/init.d/tinyproxy restart
		exit 0
	else
		echo "FAIL: '$pf' does not exist."
		exit 1
	fi
}

case $cmd in
	show)
		currentprofile
		;;
	is)
		if [ "$(currentprofile)" = "$arg2" ];
		then
			exit 0
		else
			exit 1
		fi
		;;
	set)
		setprofile "$arg2"
		;;
	*)
		echo "$0 <show|is|set> ..."
		exit 0
		;;
esac
